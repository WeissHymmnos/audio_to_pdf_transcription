<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>音视频AI总结PDF</title>
<meta name="color-scheme" content="light dark"/>
<style>
:root{
  --bg:#ffffff;
  --surface:#f6f8fa;
  --primary:#0066ff;
  --primary-light:#4d94ff;
  --text:#111827;
  --text-secondary:#4b5563;
  --border:#e5e7eb;
  --radius:20px;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  --shadow:0 8px 32px rgba(0,0,0,.08);
}
@media (prefers-color-scheme:dark){
  :root{
    --bg:#0d1117;
    --surface:#161b22;
    --primary:#4e8cff;
    --primary-light:#82b1ff;
    --text:#e6edf3;
    --text-secondary:#8b949e;
    --border:#30363d;
    --shadow:0 8px 32px rgba(0,0,0,.3);
  }
}
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:var(--font);
}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  transition:background .3s;
}
.container{
  width:100%;
  max-width:560px;
  padding:24px;
}
h1{
  text-align:center;
  font-size:2rem;
  font-weight:700;
  margin-bottom:28px;
  background:linear-gradient(135deg,var(--primary),#a855f7);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:32px 28px;
  box-shadow:var(--shadow);
  backdrop-filter:blur(12px);
}
.drop-zone{
  position:relative;
  border:2.5px dashed var(--border);
  border-radius:16px;
  padding:56px 20px;
  text-align:center;
  cursor:pointer;
  transition:border .3s,background .3s,transform .3s;
}
.drop-zone:hover{
  border-color:var(--primary);
  background:rgba(0,102,255,.05);
}
.drop-zone.dragover{
  border-color:var(--primary);
  background:rgba(0,102,255,.1);
  transform:scale(1.02);
}
.drop-zone p{
  font-size:1.1rem;
  margin-bottom:6px;
}
.drop-zone small{
  color:var(--text-secondary);
  font-size:.85rem;
}
#file-input{
  position:absolute;
  inset:0;
  opacity:0;
  cursor:pointer;
}
.progress-bar{
  margin-top:24px;
  height:6px;
  background:var(--border);
  border-radius:3px;
  overflow:hidden;
}
.progress-bar span{
  display:block;
  height:100%;
  background:var(--primary);
  width:0%;
  transition:width .4s;
}
.steps{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  font-size:.8rem;
  color:var(--text-secondary);
}
.steps .active{
  color:var(--primary);
  font-weight:600;
}
.action-area{
  margin-top:24px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}
.file-name{
  font-size:.95rem;
  color:var(--text-secondary);
  word-break:break-all;
}
.upload-btn{
  padding:14px 40px;
  font-size:1.05rem;
  font-weight:600;
  color:#fff;
  background:var(--primary);
  border:none;
  border-radius:12px;
  cursor:pointer;
  transition:transform .2s,box-shadow .2s;
  box-shadow:0 4px 14px rgba(0,102,255,.3);
}
.upload-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(0,102,255,.4);
}
.upload-btn:disabled{
  opacity:.6;
  cursor:not-allowed;
  transform:none;
}
.msg{
  margin-top:24px;
  font-size:1rem;
  text-align:center;
  min-height:24px;
}
.spinner{
  display:inline-block;
  width:16px;
  height:16px;
  border:2px solid #ffffff40;
  border-top-color:#fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-right:6px;
  vertical-align:-2px;
}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
  <h1>音视频AI总结PDF</h1>
  <div class="card">
    <div class="drop-zone" id="dropZone">
      <p>点击或拖拽文件至此处</p>
      <small>支持 mp3/wav/m4a/mp4/mov 等格式，单文件 ≤ 900 MB</small>
      <input type="file" id="fileInput" accept="audio/*,video/*">
    </div>

    <div class="progress-bar"><span id="progress"></span></div>
    <div class="steps">
      <span id="st1">上传</span>
      <span id="st2">转写</span>
      <span id="st3">总结</span>
      <span id="st4">PDF</span>
    </div>

    <div class="action-area">
      <div class="file-name" id="fileName"></div>
      <button class="upload-btn" id="uploadBtn">一键生成 PDF</button>
    </div>

    <div class="msg" id="msg"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const dropZone   = $('#dropZone');
const fileInput  = $('#fileInput');
const fileName   = $('#fileName');
const uploadBtn  = $('#uploadBtn');
const msgBox     = $('#msg');
const progress   = $('#progress');

let file = null;
let uid  = null;

;['dragover','dragenter'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover')));
;['dragleave','dragend','drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover')));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  const f = [...e.dataTransfer.files].filter(f => /audio|video/.test(f.type))[0];
  if(f) handleFile(f);
});
fileInput.onchange = () => handleFile(fileInput.files[0]);

function handleFile(f){
  if(f.size > 900*1024*1024) return msg('文件过大，请 ≤ 900 MB');
  file = f;
  fileName.textContent = '已选：'+f.name;
  uploadBtn.disabled = false;
  msgBox.textContent = '';
}

uploadBtn.onclick = async () => {
  if(!file) return msg('请先选择文件');
  uploadBtn.disabled = true;
  setStep(1);

  const chunkSize = 10<<20;
  let offset = 0;
  uid = crypto.randomUUID();
  while(offset < file.size){
    const chunk = file.slice(offset, offset+chunkSize);
    const fd = new FormData();
    fd.append('audio', chunk);
    fd.append('uid', uid);
    fd.append('total', file.size);
    fd.append('index', Math.floor(offset/chunkSize));
    const res = await fetch('/', {method:'POST', body:fd});
    if(!res.ok) { msg('上传失败'); reset(); return; }
    offset += chunkSize;
    progress.style.width = Math.min(100, (offset/file.size)*70) + '%';
  }
  setStep(2);
  pollStatus();
};

function pollStatus(){
  fetch('/status/'+uid)
    .then(r => r.json())
    .then(j => {
      progress.style.width = (j.percent || 0) + '%';
      if(j.status === 'processing'){
        setTimeout(pollStatus, 1000);
        return;
      }
      if(j.status === 'error'){
        msg('处理失败：'+j.message);
        reset(); return;
      }
      if(j.status === 'done'){
        progress.style.width = '100%';
        msg('生成完成，正在下载…');
        setTimeout(()=> window.location.href = j.download, 800);
      }
    })
    .catch(() => setTimeout(pollStatus, 2000));
}

function setStep(n){
  [1,2,3,4].forEach(i => $('#st'+i).classList.toggle('active', i===n));
}
function msg(txt){ msgBox.textContent = txt; }
function reset(){
  uploadBtn.disabled = false;
  uploadBtn.textContent = '重新生成';
  progress.style.width = '0%';
}
</script>
</body>
</html>
